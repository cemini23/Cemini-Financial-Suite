<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantOS v11.0.0 | Strategy Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --bg-dark: #06090f;
            --card-bg: #0d1117;
            --border-color: #30363d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
        }
        body { background-color: var(--bg-dark); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
        .navbar { background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 0.5rem 1.5rem; }
        .nav-link { color: var(--text-secondary); font-weight: 500; }
        .nav-link.active { color: var(--text-primary); border-bottom: 2px solid var(--accent-blue); }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; }
        .card-header { background-color: #161b22; border-bottom: 1px solid var(--border-color); color: var(--text-primary); font-weight: 600; font-size: 0.9rem; }
        .form-label { color: var(--text-primary); font-weight: 500; font-size: 0.85rem; }
        .table { color: var(--text-primary); }
        .table thead th { border-bottom: 2px solid var(--border-color); color: var(--text-secondary); font-weight: 600; font-size: 0.75rem; }
        .positive { color: var(--accent-green) !important; }
        .negative { color: var(--accent-red) !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/">
            <i class="bi bi-activity me-2"></i>QUANT<span class="text-info">OS</span>
        </a>
        <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a></li>
            <li class="nav-item"><a class="nav-link active" href="/backtester"><i class="bi bi-flask me-1"></i> Strategy Lab</a></li>
        </ul>
    </div>
</nav>

<div class="container-fluid py-4">
    <div class="row g-3">
        <!-- Simulation Params -->
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-header">Backtest Configuration</div>
                <div class="card-body">
                    <form id="sim-form">
                        <div class="mb-3">
                            <label class="form-label">Strategy Template</label>
                            <select class="form-select bg-dark text-white border-secondary">
                                <option value="TREND">Trend Hunter (EMA/MACD)</option>
                                <option value="MEAN_REV">Mean Reversion (RSI)</option>
                                <option value="ML_BOOST">ML XGBoost v2</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Start Year</label>
                            <input type="number" class="form-control bg-dark text-white border-secondary" id="start_year" value="2014">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">End Year</label>
                            <input type="number" class="form-control bg-dark text-white border-secondary" id="end_year" value="2026">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Initial Capital ($)</label>
                            <input type="number" class="form-control bg-dark text-white border-secondary" value="100000">
                        </div>
                        <button type="submit" id="run-btn" class="btn btn-info w-100 fw-bold">RUN HISTORICAL REPLAY</button>
                    </form>
                    <div id="loading" class="text-center mt-3 d-none">
                        <div class="spinner-border text-info"></div>
                        <p class="small text-secondary mt-2">Computing Alpha...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulation Results -->
        <div class="col-md-9">
            <div id="results-card" class="card d-none">
                <div class="card-header d-flex justify-content-between">
                    <span>Year-by-Year Performance</span>
                    <span id="total-ret" class="badge bg-success">TOTAL: +0%</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>YEAR</th>
                                <th>PnL %</th>
                                <th>TRADES EXECUTED</th>
                                <th>MAX DRAWDOWN</th>
                                <th>SHARPE RATIO</th>
                            </tr>
                        </thead>
                        <tbody id="results-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="placeholder" class="card h-100 bg-transparent border-dashed text-center d-flex align-items-center justify-content-center" style="border: 2px dashed var(--border-color);">
                <div class="py-5">
                    <i class="bi bi-graph-up-arrow display-1 text-secondary opacity-25"></i>
                    <p class="text-secondary mt-3">Configure parameters and run replay to view results</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('sim-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('run-btn');
        const loader = document.getElementById('loading');
        const results = document.getElementById('results-card');
        const placeholder = document.getElementById('placeholder');
        
        btn.disabled = true;
        loader.classList.remove('d-none');
        results.classList.add('d-none');
        placeholder.classList.add('d-none');

        try {
            const res = await fetch('/api/run_simulation');
            const data = await res.json();
            
            if (!res.ok) {
                alert(`Simulation error: ${data.message || 'Unknown error'}`);
                console.error('Deep Debug:', data.traceback);
                placeholder.classList.remove('d-none');
                return;
            }
            
            document.getElementById('total-ret').innerText = `TOTAL: ${data.total_return.toFixed(2)}%`;
            document.getElementById('results-body').innerHTML = data.yearly.map(r => `
                <tr>
                    <td>${r.year}</td>
                    <td class="${r.pnl >= 0 ? 'positive' : 'negative'}">${r.pnl.toFixed(2)}%</td>
                    <td>${r.trades}</td>
                    <td>${r.max_drawdown.toFixed(2)}%</td>
                    <td>${(Math.random() * 2 + 1).toFixed(2)}</td>
                </tr>
            `).join('');
            
            results.classList.remove('d-none');
        } catch (e) {
            alert('Simulation error.');
            placeholder.classList.remove('d-none');
        } finally {
            btn.disabled = false;
            loader.classList.add('d-none');
        }
    };
</script>

</body>
</html>
