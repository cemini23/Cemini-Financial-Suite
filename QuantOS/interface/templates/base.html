<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}QuantOS {{ version }}{% endblock %}</title>
    <link rel="icon" type="image/png" href="/static/quantos_v9_emblem.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/style.css">
    {% block head %}{% endblock %}
</head>
<body>

<nav class="navbar navbar-expand navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold d-flex align-items-center" href="/">
            <img src="/static/quantos_v9_emblem.png" alt="Logo" style="height: 32px; margin-right: 10px;">
            QUANT<span style="color: var(--accent-color)">OS</span>
        </a>
        <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link {% if page == 'dashboard' %}active{% endif %}" href="/"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a></li>
            <li class="nav-item"><a class="nav-link {% if page == 'settings' %}active{% endif %}" href="/settings"><i class="bi bi-gear me-1"></i> Engine Room</a></li>
            <li class="nav-item"><a class="nav-link {% if page == 'backtester' %}active{% endif %}" href="/backtester"><i class="bi bi-flask me-1"></i> Strategy Lab</a></li>
            <li class="nav-item"><a class="nav-link {% if page == 'analytics' %}active{% endif %}" href="/analytics"><i class="bi bi-graph-up me-1"></i> Analytics</a></li>
            <li class="nav-item">
                <button class="btn btn-link nav-link" onclick="toggleTheme()" style="text-decoration: none; cursor: pointer;">
                    <span id="theme-icon">üåô</span> Mode
                </button>
            </li>
        </ul>
        <div class="d-flex align-items-center">
            <div id="harvester-pill" class="badge rounded-pill bg-secondary d-flex align-items-center me-2" style="transition: all 0.3s; padding: 0.5rem 1rem;">
                <i class="bi bi-tractor-fill me-2"></i>
                <span id="harvester-text" class="fw-bold" style="font-size: 0.7rem; letter-spacing: 0.05rem;">HARVESTER</span>
            </div>
            <div id="connection-pill" class="badge rounded-pill bg-danger d-flex align-items-center me-3" style="transition: all 0.3s; padding: 0.5rem 1rem;">
                <span id="connection-dot" class="spinner-grow spinner-grow-sm me-2" role="status" aria-hidden="true"></span>
                <span id="connection-text" class="fw-bold" style="font-size: 0.7rem; letter-spacing: 0.05rem;">OFFLINE</span>
            </div>
            <span id="bot-status-tag" class="badge bg-success me-3">RUNNING</span>
            <button id="pause-btn" class="btn btn-warning btn-sm me-2 fw-bold">PAUSE BOT</button>
            <button id="panic-btn" class="btn btn-danger btn-sm fw-bold">PANIC SELL</button>
        </div>
    </div>
</nav>

{% block content %}{% endblock %}

<script>
    function updateConnectionStatus() {
        fetch('/api/system_status')
            .then(response => response.json())
            .then(data => {
                const pill = document.getElementById('connection-pill');
                const text = document.getElementById('connection-text');
                const dot = document.getElementById('connection-dot');
                
                const hPill = document.getElementById('harvester-pill');
                const hText = document.getElementById('harvester-text');
                
                // 1. Broker Logic
                const brokers = data.brokers || {};
                const onlineBrokers = Object.keys(brokers).filter(k => brokers[k] === true);
                const isOnline = onlineBrokers.length > 0;

                if (isOnline) {
                    pill.className = "badge rounded-pill bg-success d-flex align-items-center me-3";
                    const brokerName = onlineBrokers[0].toUpperCase();
                    text.innerText = `${brokerName} ONLINE`;
                    dot.className = "spinner-grow spinner-grow-sm me-2"; 
                    dot.style.display = "inline-block";
                } else {
                    pill.className = "badge rounded-pill bg-danger d-flex align-items-center me-3";
                    text.innerText = "DISCONNECTED";
                    dot.style.display = "none";
                }

                // 2. Harvester Logic
                const hStatus = data.harvester || "IDLE";
                hText.innerText = `HARVESTER: ${hStatus}`;
                if (hStatus === "ACTIVE") {
                    hPill.className = "badge rounded-pill bg-info text-dark d-flex align-items-center me-2";
                } else if (hStatus === "INITIALIZING") {
                    hPill.className = "badge rounded-pill bg-warning text-dark d-flex align-items-center me-2";
                } else {
                    hPill.className = "badge rounded-pill bg-secondary d-flex align-items-center me-2";
                }
            })
            .catch(err => {
                console.error("Heartbeat failed:", err);
                document.getElementById('connection-pill').className = "badge rounded-pill bg-danger d-flex align-items-center me-3";
                document.getElementById('connection-text').innerText = "ERROR";
            });
    }

    // Poll every 5 seconds
    setInterval(updateConnectionStatus, 5000);
    // Run immediately on load
    window.addEventListener('DOMContentLoaded', updateConnectionStatus);
</script>

<footer class="text-center py-3 opacity-50">
    <small>QuantOS {{ version }} ({{ build }}) | ¬© 2026 Cemini Financial</small>
</footer>

<script>
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        // Save preference
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            document.getElementById('theme-icon').innerText = '‚òÄÔ∏è';
        } else {
            localStorage.setItem('theme', 'light');
            document.getElementById('theme-icon').innerText = 'üåô';
        }
    }
    // Load preference
    window.onload = function() {
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            if(document.getElementById('theme-icon')) {
                document.getElementById('theme-icon').innerText = '‚òÄÔ∏è';
            }
        }
    }
</script>
<script>
    // Global scripts if needed
</script>
{% block scripts %}{% endblock %}

</body>
</html>
