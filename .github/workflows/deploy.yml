name: Secure PII Audit & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install flake8
        run: pip install flake8

      - name: Run flake8
        id: flake8
        continue-on-error: false
        run: |
          flake8 . \
            --exclude="venv,.venv,venv_new,__pycache__,.git,QuantOS/data/kaggle_import,Kalshi by Cemini/venv,Kalshi by Cemini/venv_new,Cemini-Suite" \
            --config=.flake8

  pip-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit (all requirements files)
        run: |
          pip-audit \
            -r requirements.txt \
            -r QuantOS/requirements.txt \
            -r "Kalshi by Cemini/requirements.txt" \
            --strict

  bandit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install bandit
        run: pip install bandit

      - name: Run bandit (SAST) â€” generate JSON report
        # Non-blocking: always produces the artifact even if issues are found
        run: |
          bandit -r . -ll -ii \
            --exclude ./tests,./venv,./.venv,./venv_new,./Cemini-Suite,./QuantOS/data/kaggle_import \
            -f json -o bandit-report.json || true

      - name: Upload bandit JSON report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json
          retention-days: 30

      - name: Run bandit (SAST) â€” enforce HIGH findings fail
        # This step determines pass/fail: exits non-zero if any HIGH severity issue is found
        run: |
          bandit -r . -ll -ii \
            --exclude ./tests,./venv,./.venv,./venv_new,./Cemini-Suite,./QuantOS/data/kaggle_import \
            -f screen

  audit-and-deploy:
    # All three parallel checks must pass before secrets scan + deploy
    needs: [lint, pip-audit, bandit]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ensures TruffleHog can scan the entire history for secrets

      # 1. PII & SECRET AUDIT (The Gatekeeper)
      # This scans for hardcoded API keys, passwords, and PII

      # For pull requests: scan the diff between PR base and head
      - name: TruffleHog Secret Scan (pull_request)
        id: security-pr
        continue-on-error: false
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified --results=verified,unknown
        if: github.event_name == 'pull_request'

      # For direct pushes to main: scan only the commits in this push
      - name: TruffleHog Secret Scan (push)
        id: security
        continue-on-error: false
        uses: trufflesecurity/trufflehog@main
        with:
          base: ${{ github.event.before }}
          head: ${{ github.event.after }}
          extra_args: --only-verified
        if: github.event_name == 'push'

      # 2. SECURE DEPLOYMENT VIA SSH
      # Requires a GitHub secret: DEPLOY_SSH_KEY (private key for root@5.161.53.103)
      # To set up: Settings â†’ Secrets â†’ Actions â†’ New repository secret
      #   Name: DEPLOY_SSH_KEY
      #   Value: contents of your private key (~/.ssh/id_ed25519 or similar)
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" | tr -d '[:space:]' | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 5.161.53.103 >> ~/.ssh/known_hosts

      - name: Update Bot on Server
        id: deploy
        continue-on-error: false
        run: |
          echo "Deploying Cemini Suite to 5.161.53.103..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes root@5.161.53.103 "
            set -e &&
            cd /opt/cemini &&
            git pull origin main &&
            [ -f .env ] || { echo 'ERROR: .env missing on server â€” aborting docker deploy'; exit 1; } &&
            docker compose down &&
            docker compose up --build -d &&
            sleep 10 &&
            docker compose ps
          "

      # 3. CI SUMMARY â€” always runs so you can see results at a glance
      - name: CI Summary
        if: always()
        run: |
          echo "=== CI RESULTS ==="
          echo "Lint (flake8):   ${{ needs.lint.result }}"
          echo "Dep scan (pip-audit): ${{ needs.pip-audit.result }}"
          echo "SAST (bandit):   ${{ needs.bandit.result }}"
          echo "Secret Scan:     ${{ steps.security.outcome }}"
          echo "Deploy:          ${{ steps.deploy.outcome }}"
          echo ""
          if [ "${{ steps.deploy.outcome }}" = "failure" ]; then
            echo "âš ï¸  Deploy failed â€” SSH or docker compose error on server"
          fi
          if [ "${{ steps.deploy.outcome }}" = "success" ]; then
            echo "âœ… Deployed successfully to root@5.161.53.103:/opt/cemini"
          fi

  # â”€â”€ AUTO-DOCUMENTATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Runs in parallel with audit-and-deploy after security gates pass.
  # Parses docker-compose.yml, requirements, and test suite to inject fresh
  # sections into README.md, PROJECT_SUMMARY.md, and per-directory READMEs.
  # Only commits when content actually changed â€” never creates empty commits.
  # [skip ci] in the commit message prevents infinite CI loops.
  update-docs:
    runs-on: ubuntu-latest
    needs: [lint, pip-audit, bandit]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pyyaml pytest

      - name: Generate documentation
        run: python scripts/generate_docs.py

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md PROJECT_SUMMARY.md \
                  QuantOS/README.md \
                  "Kalshi by Cemini/README.md" \
                  trading_playbook/README.md || true
          if git diff --cached --quiet; then
            echo "ğŸ“ No documentation changes to commit."
          else
            git commit -m "docs: auto-update READMEs [skip ci]"
            git push
            echo "ğŸ“ Documentation committed and pushed."
          fi

# NOTE â€” Docker layer caching:
# Builds run on the VPS server (via SSH in the deploy step), not inside the
# GitHub Actions runner. The server's local Docker layer cache already provides
# layer reuse between runs. GitHub Actions GHA cache (type=gha) applies only
# when docker/build-push-action builds inside the runner â€” N/A here.
